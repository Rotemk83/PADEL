<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Padel Monitor Dashboard</title>

    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">

    <style>
        body { font-family: 'Inter', sans-serif; background:#f4f7f9; }
        .scroll-container::-webkit-scrollbar { height: 8px; }
        .scroll-container::-webkit-scrollbar-thumb { background:#cbd5e1; border-radius:10px; }
    </style>
</head>

<body class="p-4 sm:p-8">

<div class="max-w-6xl mx-auto bg-white p-6 sm:p-8 rounded-xl shadow-2xl">

    <header class="mb-8 border-b pb-4">
        <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-900">ðŸŽ¾ Live Padel Court Monitor - Rishon Lezion</h1>
        <p id="last-updated" class="text-sm text-gray-500 mt-1"></p>
    </header>

    <!-- Filters -->
    <div class="mb-6 flex flex-col sm:flex-row gap-4 justify-between items-center">
        <input id="search-input" type="text" placeholder="Search by Location..."
            class="w-full sm:w-64 p-3 border rounded-lg focus:ring-green-500">
        
        <div class="flex items-center space-x-4">
            <label class="text-gray-700 font-medium">Filter Status:</label>
            <select id="status-filter" class="p-3 border rounded-lg focus:ring-green-500">
                <option value="all">All Statuses</option>
                <option value="available">Available</option>
                <option value="booked">Booked</option>
            </select>
        </div>
    </div>

    <!-- Table -->
    <div class="scroll-container overflow-x-auto shadow-inner rounded-lg border border-gray-100">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50">
                <tr>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Location</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Time Slot</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Status</th>
                    <th class="px-6 py-3 text-left text-xs font-semibold text-gray-500 uppercase">Last Checked</th>
                </tr>
            </thead>
            <tbody id="courts-table-body" class="bg-white divide-y divide-gray-200">
                <tr><td colspan="4" class="text-center py-6 text-gray-500">Loading court data...</td></tr>
            </tbody>
        </table>
    </div>

    <div id="error-message" class="hidden mt-6 bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded-lg">
        <strong>Error:</strong> <span id="error-text">Failed to load data.</span>
    </div>

</div>

<script>
/* CONFIG */
const SHEET_ID = '1O76uXL2OjkzvhRlL70xQG6nwmgUJGoDcRK9gOCR_7xY';
const SHEET_GID = '707982245';
const SHEET_URL = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&gid=${SHEET_GID}`;

/* COLUMN NAMES MATCHING YOUR SHEET EXACTLY */
const COLUMN_MAP = ['Location', 'Time', 'status', 'Last_Checked'];

/* Convert "4-4:30 PM" â†’ "16:00-16:30" */
function convertTo24Hour(timeRange) {
    if (!timeRange || typeof timeRange !== "string") return timeRange;

    try {
        // Normalize formats: add space before AM/PM if missing
        timeRange = timeRange.replace(/(AM|PM)$/i, " $1").trim();

        // Now split safely
        const parts = timeRange.split(" ");
        const period = parts.pop().toUpperCase();   // AM or PM
        const range = parts.join(" ").split("-");

        const convert = (t) => {
            let [h, m] = t.split(":");
            h = parseInt(h);
            m = m ? parseInt(m) : 0;

            if (period === "PM" && h !== 12) h += 12;
            if (period === "AM" && h === 12) h = 0;

            return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}`;
        };

        return `${convert(range[0])}-${convert(range[1])}`;
    } catch (err) {
        console.warn("Time conversion failed for:", timeRange);
        return timeRange;
    }
}

/* Fetch with Retry */
async function fetchText(url) {
    for (let i = 0; i < 3; i++) {
        try {
            const r = await fetch(url);
            if (!r.ok) throw new Error("Fetch failed");
            return await r.text();
        } catch { await new Promise(r => setTimeout(r, 500)); }
    }
    throw new Error("Failed after retries");
}

let courtData = [];

/* Fetch + Parse */
async function loadData() {
    try {
        const raw = await fetchText(SHEET_URL);
        const json = JSON.parse(raw.substring(raw.indexOf("{"), raw.lastIndexOf("}") + 1));

        const rows = json.table.rows;

        courtData = rows.map(row => {
            let out = {};
            row.c.forEach((cell, i) => out[COLUMN_MAP[i]] = cell ? (cell.v || cell.f || '') : '');
            return out;
        });

        /* REMOVE HEADER ROW AUTOMATICALLY */
        if (courtData.length && courtData[0].Location === "Location") {
            courtData.shift();
        }

        renderTable(courtData);

        document.getElementById("last-updated").textContent =
            "Last updated: " + new Date().toLocaleTimeString();

    } catch (e) {
        document.getElementById("error-message").classList.remove("hidden");
        document.getElementById("error-text").textContent = e.message;
    }
}

/* Render Table */
function renderTable(data) {
    const tbody = document.getElementById("courts-table-body");

    if (!data.length) {
        tbody.innerHTML =
            '<tr><td colspan="4" class="text-center py-6 text-gray-500">No data available</td></tr>';
        return;
    }

    tbody.innerHTML = data.map(row => {
        const time24 = convertTo24Hour(row.Time);
        const status = (row.status || '').toLowerCase();

        const color =
            status.includes("available") ? "bg-green-100 text-green-800" :
            status.includes("booked") ? "bg-red-100 text-red-800" :
            "bg-yellow-100 text-yellow-800";

        return `
        <tr class="hover:bg-gray-50">
            <td class="px-6 py-4">${row.Location}</td>
            <td class="px-6 py-4">${time24}</td>
            <td class="px-6 py-4">
                <span class="px-3 py-1 rounded-full text-xs font-semibold ${color}">
                    ${status}
                </span>
            </td>
            <td class="px-6 py-4">${row.Last_Checked}</td>
        </tr>`;
    }).join('');
}

/* Search + Filter */
document.getElementById("search-input").addEventListener("input", filterData);
document.getElementById("status-filter").addEventListener("change", filterData);

function filterData() {
    const term = document.getElementById("search-input").value.toLowerCase();
    const statusFilter = document.getElementById("status-filter").value;

    const filtered = courtData.filter(r =>
        r.Location.toLowerCase().includes(term) &&
        (statusFilter === "all" || r.status.toLowerCase().includes(statusFilter))
    );

    renderTable(filtered);
}

/* Init */
loadData();
setInterval(loadData, 300000); // refresh every 5 minutes
</script>

</body>
</html>
